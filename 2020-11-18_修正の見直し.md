# 貯留池修正の見直し

## 本タスクの目的
- 今回した修正は実現したいことから考えて正しいものだったかを検証する
- 今回した修正によって新たな問題が発生していないか（見つかっていないか）を確認する
- 潜在バグを見つける＝修正したところと同じ書き方をしている箇所を見つけ、（同じような）バグが出ないか検討、出るなら修正としてピックアップ
    - 観点：配列の要素が想定から変わりうるか？
        - イレギュラーなケースを想定する（都合よくない、テストケースとして起こせてないケース）
        - １，２，飛んで４のケースがテストできてないので追加
        
貯留池にやること
- １，２，飛んで４のケースがテストできてないので追加
- データパターンが足りてないケースを探す

- 期待通りに挙動しないところを探す
  - 特定のデータパターンで挙動がおかしくなるなど
　- あったら報告
- 藤原さんが判断
- その箇所を修正
- 動作確認
- おとといからの修正（差分）から今回の修正までを考えて増えたデータパターンを検討、Excelに追加
- 単体テストケース追加するか検討、追加
- 単体テスト実行
- OK出たらレビュー

## 本タスクの目標
- 今回の修正で具体的に何をやったかを言語化し、今一度把握する
    - ←急ぎで指示を受けながら作ったので理解しないまま実装している可能性があるため
- 今回の修正が実現したいことから考えて正しくない可能性を検討し、そうでないことを確認する
- 今回の修正よりよい方法を検討する？
- 今回の修正によってわかったことを活かし、他の処理に適用することを検討する
- 今回の修正により既存のテストケースだけでは足りなくなった／多すぎる可能性を検討する
    - 足りなくなったことがわかれば、追加する

## 指示メモ
- 今回の修正、直し方が正しいか？理解したか？再現できるか？
    - 要望（仕様）通りの作れてるか？
    - どこの間違いをどう直したか
    - 急ぎにつき見落としているケースがあるかもしれない
- 配列の要素同士をマッチさせる処理、$iを使うともろいので他に使われてるところを探して
- 足りてないテストケース（fromデータパターン）を追加する

## 報告メモ
- 修正１（L217）processForAPIにおいて、作った観測日時を現在時刻に書き換える修正
    - 要望通りか？はい
        -  一度作った日付データを明示的にバッチを実行した日時に書き換えているため
    - どこの間違いをどう直したか
        - 修正前：データ化するレコードの中で最も新しい日時を観測日時としていた
        - 修正後：当該処理のあとバッチを実行した日時に上書きするように修正した。
    - 見落としているケースはあるか？
        - 直近：ない
            - $db_dataがある場合
                - 
            - $db_dataがなかった場合は？
                - $api_dataが要素０の配列のままになる
                - 当該foreachが0回動く（エラーにはならない）
                - 欠測の場合も現在時刻（もとから）
                - ゆえに、問題はない
        - 欠測：ない
            - 欠測時の観測日時はもともとのデータの観測日時を流用するのでは？
                - そのとおり、修正２で対応済
                - ゆえに問題にならない

- 修正２（L97）欠測再取得し、processForAPI後、各要素の観測日時を
それぞれのもともとの時間（sendテーブルにある時間）に書き換える処理
    - 要望通りか？　はい
        - 欠測再取得のもとになるデータは欠測を出した時間、すなわち欠測データがつくられたバッチ処理を行った日時のため
    - どこの間違いをどう直したか
        - 修正１：
            - 修正前：欠測再取得にあたって明示的にもともとの日時を代入することはしていなかった
            - 修正後：再取得データ作成後明示的にもともとの日付を代入するようにした。
        - 修正２：
            - 修正前：配列を結合してから結合先の配列の中の要素を$iで指定して変更を行っていた
            - 修正後：今扱っているデータを一旦変数におき、それに変更を行ってから送信用の配列に結合する
    - 見落としているケースはないか？
        - 欠測再取得データがない？
            - if文で排除
        - 観測日時データがない？
            - 欠測データがsendテーブルにある以上それはない
            - sendテーブルから取れたデータ(missing_list)がなければこの処理には到達しない
        - processForAPIから期待しないものが帰ってくるケース？
            - 「期待しない」とは
                - 
            - ＝db_dataがないケース？
            - 上記はif文で排除している
