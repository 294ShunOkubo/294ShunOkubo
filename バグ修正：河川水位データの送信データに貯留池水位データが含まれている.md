## 状況
【疎通確認結果】

河川水位データ送信処理において、作成された送信データに貯留池水位データが含まれている

◆実施コマンド
php public/index.php send_river_water_level

◆実施日時
2020-11-10 11:28:10

◆対象データ
+-----+-----------------+---------------------+---------+-------+--------------+
| id | observ_point_cd | observing_time | item_cd | value | tpmorzero_cd |
+-----+-----------------+---------------------+---------+-------+--------------+
| 96 | 2320201600002 | 2020-11-10 11:10:00 | 10 | 0.046 | 0 |
| 97 | 2320201600002 | 2020-11-10 11:11:00 | 10 | 0.047 | 0 |
| 98 | 2320201600002 | 2020-11-10 11:12:00 | 10 | 0.051 | 0 |
| 99 | 2320201600002 | 2020-11-10 11:13:00 | 10 | 0.045 | 0 |
| 100 | 2320201600002 | 2020-11-10 11:14:00 | 10 | 0.048 | 0 |
| 101 | 2320201600002 | 2020-11-10 11:15:00 | 10 | 0.049 | 0 |
| 102 | 2320201600002 | 2020-11-10 11:16:00 | 10 | 0.043 | 0 |
| 103 | 2320201600002 | 2020-11-10 11:17:00 | 10 | 0.050 | 0 |
| 104 | 2320201600002 | 2020-11-10 11:18:00 | 10 | 0.055 | 0 |
| 105 | 2320201600002 | 2020-11-10 11:19:00 | 10 | 0.048 | 0 |
+-----+-----------------+---------------------+---------+-------+--------------+

◆送信データ
{
  "river":[
    {"observPointCode":"2320201600002","observTime":"2020/11/10 11:19:00","itemCode":10,"value":0.048,"status":0,"tpmOrZero":0},
    {"observPointCode":"2320200400001","observTime":"2020/11/10 11:28:10","itemCode":10,"value":0,"status":190,"tpmOrZero":0},
    {"observPointCode":"2320200400002","observTime":"2020/11/10 11:28:10","itemCode":10,"value":0,"status":190,"tpmOrZero":0},
    {"observPointCode":"2320200400003","observTime":"2020/11/10 11:28:10","itemCode":10,"value":0,"status":190,"tpmOrZero":0}
  ]
}

---

## 考えられる要因

- 期待しない機能のデータを取ってこないか確かめるテストは行っていない
- データを取得するSQL文に問題があると思われる
- 河川と貯留池はwaterLevelDaoを共有している
- 要因特定：直近データ取得SQLにデータタイプ条件がない

## 対処法

- SQL文に河川か貯留池か区別できるよう条件を追加する
  - `_____:data_type_____`
  
## 予後観察

- 動作確認はOK（ちゃんとコマンド叩いた）
- 単体テストをやる
  - 単体テスト、河川と貯留池は今回みたいなこと起きがちだからテストケース増やしたほうがいい？
  - 問題：単体テスト、全ケースfalse
    - 原因特定：selectMostRecentで例外吐いて終了している
      - ログ： Invalid parameter number: parameter was not defined [] {"uid":"5d78ff3"}
      - 新しく入れた`_____:data_type_____`がうまく認識されていない
        - LIKEを入れる
        - この形（ワイルドカードとバインドパラメータ）は苦しい？
        - もはやカラム増やしたほうが早い？
  - 解決策の検討
    - なんとかして観測所コードだけで特定する
      - 現状ノープラン
      - Where カラム like 検索対象 再検討
      - $obs_pt_listを引数に入れてin文に入れる
    - water_level にデータコードのカラム追加する
      - dumpファイル書き換え
      - テーブル定義書き換え
      - テストのcsvファイル書き換え
      - DBに挿入する側の修正（加筆）←この視点が一番大事
  - 単体テスト改良
    - ケース010、貯留池のデータをまぜる
      - 直近だけでなく欠測再取得データ、未送信データも含めて
      - 事象：欠測と未送信、必要なものが足りてない
        - 解決
      - OK
  - 修正前の状態で誤って取得していたデータが修正によって取得されなくなったことを確認する作業
    - 修正前のマスターブランチでcsvファイルのみ修正後に（貯留池を混ぜる）
    - requestedByPost.phpにjson形式の文字列をファイルに出力する
      - 出力を確認
    - 修正ブランチに戻り、同様に出力
    - 出力したファイル同士を比較ツールで比べる
