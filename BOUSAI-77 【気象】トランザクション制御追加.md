# BOUSAI-77 【気象】トランザクション制御追加

## 概要
更新処理にトランザクション制御を追加する

## 目標
浸水警報を除く４機能のinsertUpdate()にてトランザクション処理を実装する

## 提出物
- WaterLevelSendDao.php
- RainfallSendDao.php
- PumpingStationStatusSendDao.php

## 計画
各工程ごとにやることを分割

### 方針決定・計画書作成
- トランザクション処理について学ぶ
- トランザクション処理の実装方法について調査・検討する

### 実装・修正
- [x] トランザクション処理を実装する
- [x] トランザクション処理：特にロールバックが正しく挙動するか確認する
  - [x] データをセットする
    - 単体テスト用csv（case007）をもとに以下を作成
      - transaction_waterLevel.csv
      - transaction_waterLevelSend.csv
  - [ ] 更新が成功する場合と失敗する場合を試す
    - 成功する場合：ふつうに（もはや単体テストでいい）
      - 予定通りデータが更新されれば成功
    - 失敗する場合：sql間違えるor不正なデータを入れるような処理に書き換え？
      - 一部のカラムに不正なデータを入れる（更新させる）よう書き換える
        - 桁数オーバー→ふつうに受け入れ
          - 本来ありえない（もともとDBにあった値を取りに行くので）
        - null
          - どのみち入らないデータは最初から弾かれる
        - 文字列
- [ ] 当該修正によって中途半端な更新はされなくなったことを確認
### 目視確認
- 動作確認用に書き換えたところはもどした？
- トランザクションを書き換えるのはinsertUpdateだけでよい？


### 単体テスト（テスト準備～テスト実行～テスト後始末）
- 基本はいつもどおり
- 戻すまでがテスト

### 最終確認

### 提出

## メモ
- 不明点：トランザクション処理ができていることを確認するには？
  - SQL例外を発生させて、当該処理がされていないこと（ロールバックされていること）を確認
    - わざとSQLを間違えるなど
- phpのPDOにおいけるトランザクション処理のやり方
  - beginTransaction()とcommit()で囲む？
    - https://www.php.net/manual/ja/pdo.transactions.php
    - https://gray-code.com/php/transaction-by-using-pdo/
- いちおう見様見真似で実装
- 単体テストも通過
- トランザクション処理
  - 成功→普通にデータが更新される
  - 失敗→データが更新されない
  
- トランザクション確認、テストケースのcsv使って1回やる
- なぜトランザクション処理を追加するのか？
  ->複数のカラムを追加/更新するとき、
    「カラムAは更新されたがカラムBは更新されない」
    といった状況を防ぐため
    
- [ ] トランザクション中にエラーが起きたときにロールバックすることの確認
  - ロールバックするためには更新が失敗する必要
    <-更新が失敗するためには不正なデータが必要
      - [ ] 不正なデータを入れるようにコードを一時的に書き換える
    <-waterLevelは正直なんでもよい
    <-waterLevelSendは更新対象になるデータがあればよい
  - 動作確認
    - case001をアレンジ
      - 本来ケース冒頭でやるデータ挿入はtransaction_waterLevelSend.csvを手動でやる
      - 時間指定は冒頭に$GLOBAL[]を追加し行う（case008と同じunixを代入）
      - insertUpdate内で一部のデータを不正なデータに書き換える
      - Actionクラスを実行
- 想定ケース、sendが更新されないといけない

- 問題：正常にやってもなぜか送信済フラグが0のまま
  - 単体テストをやりなおす
  　- false, HTTP/1.1 500 Internal Server Error
      - 藤原さんにお願い
      - 解決
- ブランチを切り直す
- 動作確認仕様にして実行
  - undefined index error
  - csv入れ直したら治った
  - トランザクション使用前・正常ケース　確認済
- トランザクション使用前・失敗ケースを作りたい
  - 
